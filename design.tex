\documentclass[index]{subfiles}
\begin{document}
\chapter{自动化设计系统的设计}\label{sec:design}
在\cref{sec:doebgo}中已经对贝叶斯优化算法的诸多方面的细节问题进行了讨论。
然而，从算法本身到软件系统的过程又是一个相当不平凡的过程。
本章和下一章将紧扣软件实现这一主题，对自动化设计系统进行全方位的建模与设计。

经过上个世纪80至90年代软件工程领域的蓬勃发展，“4+1”视图模型\cite{kruchten1995}是在上个世纪90年代中叶被提出。
其主张通过以下5个视图（View）来对复杂软件系统进行建模：
\begin{description}
  \item[逻辑（Logical）视图] 描述系统给用户提供何种功能
  \item[流程（Process）视图] 描述工作流中的并发和同步
  \item[开发（Development）视图] 描述开发过程中软件的静态组织关系
  \item[物理（Physical）视图] 描述软件与硬件的映射关系
  \item[场景（Scenario）视图] 基于某个用户用例（场景），展示以上四个视图如何配合
\end{description}

在该理论提出之初，各个视图普遍采用当时最为流行的Booch记号进行绘制，且一切基于当时非常看好的面向对象编程范式。
虽然软件工程领域在其后二十年内沧海桑田，Booch记号早已淘汰，UML语言以其强大的表现力和规范化成为了软件模型的绝对标准，面向函数范式渐渐取代面向对象，
但“4+1”视图的基本原理依然沿用至今，只不过普遍采用UML语言进行表达。

本文考虑到自动化设计系统软件的特殊性——交互较少（提交任务以后基本无需干预），但工作流却异常复杂（执行非常复杂的算法），
在“4+1”视图的基本思想指导下，选取其中部分视图对系统进行建模：
\begin{description}
  \item[逻辑视图] 采用UML用户用例图来描述系统给用户提供何种功能（\cref{sec:design-usecase}）
  \item[（优化场景下的）流程视图] 采用UML活动图和FL-Petri网描述优化工作流中的并发和同步（\cref{sec:design-wf}）
  \item[开发视图] 采用UML组件图描述开发过程中软件的静态组织关系（\cref{sec:design-comp}；\cref{sec:impl}中会对其进行细化）
  \item[物理视图] 采用UML部署图描述软件与硬件的映射关系（将在\cref{sec:impl}中讨论）
\end{description}

\section{逻辑视图：用户用例}\label{sec:design-usecase}
\begin{figure}[h]
  \centering
  \includegraphics{./figures/dist/design-usecase.pdf}
  \caption{系统逻辑视图：UML用户用例图\label{fig:design-usecase}}
\end{figure}
自动化设计系统只有设计者一类用户。\Cref{fig:design-usecase}具体描述了系统可以给设计者提供的功能（用户用例）。

\section{流程视图：贝叶斯优化算法的工作流建模}\label{sec:design-wf}
\begin{figure}[h]
  \centering
  \includegraphics{./figures/dist/design-activity.pdf}
  \caption{系统流程视图：UML活动图\label{fig:design-activity}}
\end{figure}
本节将会仔细讨论\cref{fig:design-usecase}中的发布、中止、修改任务的工作流。

\subsection{利用UML活动图初步建模工作流}
在\cref{sec:fea}中指出，待优化的设计变量可能包括分类变量、离散变量和连续变量三种类型。
对于分类变量，由于不同分类之间的结果没有任何可比性，故在工作流一开始应该先枚举所有分类变量的可能组合，为每种组合创建一个分类，并行执行各分类的工作流。

每个分类对应着一个完整的贝叶斯优化算法。首先，根据\cref{ssec:bgo-init}的讨论结果，采用LHSMDU算法计算出$N_\mathrm{init}$组初始实验位置。
随后同时开始各个位置的求值——依次计算几何参数、Ansys仿真、电参数、性能参数、目标函数，
而在可以同一级参数中尽量并发执行。需要注意的是，若同一级参数中有互相依赖的情况（比如一个电参数依赖另外几个电参数），需要妥善进行处理。

在任何一组实验求值完毕之后，根据\cref{ssec:bgo-acq}的讨论，应该计算下一步最佳求值位置。
然而，在实际设计过程中，应该考察是否已经完成了$N_\mathrm{min}$组实验；若已经完成的实验太少，则不应该盲目开展新的迭代，以免浪费。
需要注意的是，$N_\mathrm{min}$应该满足$N_\mathrm{min} \leq N_\mathrm{init}$的条件，否则永远无法开始迭代。

本文采用的收敛条件有两个，任一满足即视作收敛：
\begin{description}
  \item[主动收敛] 若最佳收获函数（EPI的最大值）小于某个给定常数，表明无论在哪里选点都无法获得很高的目标函数性能提升，此时可以认为算法已经收敛。
  \item[被动收敛] 若最佳实验位置处已经进行过实验，则表明样本空间已经探索殆尽，此时可以认为算法收敛。
\end{description}

在所有分类均收敛后，只需比较各分类的结果，找到全局最优即可。

\Cref{fig:design-activity}利用UML活动图对发布任务的工作流进行了建模。
需要注意的是，由于UML活动图并不能正确地表示动态分支结构（见\cref{sec:petri}中的讨论），
\cref{fig:design-activity}中只画出了部分工作流。

\subsection{利用FL-Petri网详细建模工作流}
\begin{figure}[h]
  \centering
  \includegraphics{./figures/dist/design-petri1.pdf}
  \caption{系统流程视图：FL-Petri网（全局）\label{fig:design-petri1}}
\end{figure}


\Cref{ssec:bgo}

\section{开发视图：系统核心组件划分}\label{sec:design-comp}
% TODO
\end{document}
